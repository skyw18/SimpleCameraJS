<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <title>SimpleCameraJS</title>
    <style>
      /* ç®€å•è®¾ç½®ä¸€ä¸‹æŒ‰é’®é£æ ¼ */
      button {
        width: 120px;
        height: 45px;
        font-size: 15px;
        border-radius: 2em;
        transition: all 0.1s linear;
        box-shadow: 2px 2px 4px #c5c5c5, -2px -2px 4px #f3f3f3;
        border: 1px solid #e0e0e0;
      }

      button:not(:disabled):hover {
        box-shadow: 6px 6px 12px #c5c5c5, -6px -6px 12px #f3f3f3;
      }

      button:not(:disabled):active {
        transform: scale(0.95);
        box-shadow: none;
      }

      /* ä»¥ä¸‹cssä¸ºæ‘„åƒå¤´æ˜¾ç¤ºè§†é¢‘ç•Œé¢å‘¨å›´çš„è¾¹æ¡†ï¼Œä»¿é€ æ‘„åƒæœºï¼Œæ›´åŠ ç¾è§‚ï¼ŒåŒæ—¶åœ¨å››è§’æ˜¾ç¤ºåˆ†è¾¨ç‡ï¼Œå¸§æ•°å’Œå½•åƒæ—¶é—´ç­‰ä¿¡æ¯ */
      /* å‚è€ƒä»£ç  https://blog.cubieserver.de/2020/how-to-create-a-video-camera-like-overlay-with-html-css/  */
      .overlay {
        --border-style: 2px solid white;
        --border-space: 20px;
        position: absolute;
        width: 1280px;
        height: 720px;
      }

      .overlay-helper {
        position: absolute;
        width: 100%;
        height: 100%;
      }

      .overlay-element {
        padding: 20px;
        width: 150px;
        height: 100px;
        position: absolute;
      }

      .overlay-text {
        font-size: 18px;
        color: white;

        text-shadow: 1px 1px 0 rgb(58, 58, 58), -1px 1px 0 rgb(58, 58, 58),
          1px -1px 0 rgb(58, 58, 58), -1px -1px 0 rgb(58, 58, 58);
      }

      .overlay .top-left {
        border-left: var(--border-style);
        border-top: var(--border-style);
        top: var(--border-space);
        left: var(--border-space);
        text-align: left;
      }

      .overlay .top-right {
        border-right: var(--border-style);
        border-top: var(--border-style);
        top: var(--border-space);
        right: var(--border-space);
        text-align: right;
      }

      .overlay .bottom-left {
        border-left: var(--border-style);
        border-bottom: var(--border-style);
        bottom: var(--border-space);
        left: var(--border-space);
        text-align: left;
      }

      .overlay .bottom-right {
        border-right: var(--border-style);
        border-bottom: var(--border-style);
        bottom: var(--border-space);
        right: var(--border-space);
        text-align: right;
      }

      #overlay-bottom-left-text {
        position: absolute;
        bottom: var(--border-space);
        left: var(--border-space);
      }

      #overlay-bottom-right-text {
        position: absolute;
        bottom: var(--border-space);
        right: var(--border-space);
      }

      .blink {
        animation: blink 0.5s linear infinite alternate;
      }

      .fade {
        animation: fade 2s;
        animation-timing-function: ease-in-out;
        animation-fill-mode: forwards;
      }

      @keyframes fade {
        to {
          opacity: 0;
        }
      }

      @keyframes blink {
        0% {
          opacity: 1;
        }

        100% {
          opacity: 0;
        }
      }
    </style>
  </head>
  <body>
    <div style="display: flex; width: 600px; justify-content: space-around">
      <button id="open" onclick="open_camera()">å¼€å¯æ‘„åƒå¤´</button>
      <button id="record" onclick="record_act()" disabled="true">
        å¼€å§‹å½•åƒ
      </button>
      <!-- <button id="stop" onclick="record_stop()">åœæ­¢å½•åƒ</button> -->
      <button id="photo" onclick="take_photo()" disabled="true">æˆªå›¾</button>
      <!-- <button id="close" onclick="close_camera()">å…³é—­æ‘„åƒå¤´</button> -->
    </div>
    <br />
    <div id="content">
      <div class="overlay">
        <div class="overlay-helper">
          <div class="overlay-element top-left">
            <span
              id="overlay-top-left-text"
              class="overlay-text blink"
              style="display: none"
            >
              ğŸ”´ REC
            </span>
          </div>
          <div class="overlay-element top-right">
            <span
              id="overlay-top-right-text"
              class="overlay-text"
              style="display: none"
            >
              00:00
            </span>
          </div>
          <div class="overlay-element bottom-left">
            <span
              id="overlay-bottom-left-text"
              class="overlay-text"
              style="display: none"
            >
              1 FPS
            </span>
          </div>
          <div class="overlay-element bottom-right">
            <span
              id="overlay-bottom-right-text"
              class="overlay-text"
              style="display: none"
            >
              1x1
            </span>
          </div>
        </div>
        <!-- è¿™é‡Œå¯ä»¥æ”¾ä¸€ä¸ªlogo ç„¶åå®ç°æ¸éšæ•ˆæœ -->
        <div
          style="
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
          "
          id="div_logo"
        >
          <img src="logo.png" height="140px" draggable="false" alt="LOGO" />
        </div>
      </div>
    </div>

    <video
      id="video"
      width="1280"
      height="720"
      autoplay
      style="border: 2px solid #c5c5c5"
    ></video>

    <!-- <script src="js/jquery-3.7.0.min.js"></script> -->
    <script src="RecordRTC.js"></script>
    <script>
      "use strict";
      var scale = 1;
      var recorder;
      var video = document.getElementById("video");
      var video_width = 1280;
      var video_height = 720;
      var video_fps = 60;
      //var img = document.getElementById("img");

      var timer = null;
      var start_time;
      var now_time;

      //é»˜è®¤ç¼–ç 
      let mimeType = "video/webm\;codecs=h264"; // H264
      let recorderType = MediaStreamRecorder;
      //åŠ å…¥å¯¹æ”¯æŒçš„ç¼–ç æ ¼å¼è¿›è¡Œæµ‹è¯•çš„ä»£ç 
      isMimeTypeSupported("video/webm\;codecs=h264"); //H264
      isMimeTypeSupported("video/x-matroska;codecs=avc1"); //MKV
      isMimeTypeSupported("video/webm\;codecs=vp9"); //VP9
      isMimeTypeSupported("video/webm\;codecs=vp8"); //VP8
      isMimeTypeSupported("video/mpeg"); // video/mp4;codecs=avc1
      isMimeTypeSupported("video/mp4;codecs=avc1"); // video/mp4;codecs=avc1
      isMimeTypeSupported("video/webm"); // do NOT pass any codecs (vp8 by default)
      //isMimeTypeSupported("video/webm\;codecs=vp10"); // JUST TEST

      //è‡ªè¡Œåˆ‡æ¢ç¼–ç æ ¼å¼
      if (isMimeTypeSupported(mimeType) === false) {
        mimeType = "video/x-matroska;codecs=avc1"; // MKV

        if (isMimeTypeSupported(mimeType) === false) {
          mimeType = "video/webm\;codecs=vp9"; // VP9

          if (isMimeTypeSupported(mimeType) === false) {
            mimeType = "video/webm\;codecs=vp8"; // VP8

            if (isMimeTypeSupported(mimeType) === false) {
              mimeType = "video/webm"; // ä¸ä½¿ç”¨ä»»ä½•ç¼–ç å™¨ (é»˜è®¤vp8)

              if (isMimeTypeSupported(mimeType) === false) {
                //åˆ‡æ¢åˆ°Whammyç¼–ç å™¨ (WebP+WebM)
                mimeType = "video/webm";
                recorderType = WhammyRecorder;
              }
            }
          }
        }
      }

      function isMimeTypeSupported(mimeType) {
        if (typeof MediaRecorder === "undefined") {
          console.log(mimeType, "is *** NOT *** supported.");
          return false;
        }

        if (typeof MediaRecorder.isTypeSupported !== "function") {
          console.log(mimeType, "is supported.");
          return true;
        }
        var ret = MediaRecorder.isTypeSupported(mimeType);
        if (ret === false) {
          console.log(mimeType, "is *** NOT *** supported.");
        } else {
          console.log(mimeType, "is supported.");
        }
        return ret;
      }

      //å¼€å¯æ‘„åƒå¤´ä¹‹åæ˜¾ç¤ºåº•éƒ¨ä¿¡æ¯
      function show_bottom() {
        document.getElementById("overlay-bottom-left-text").style.display = "";
        document.getElementById("overlay-bottom-right-text").style.display = "";
        document.getElementById("div_logo").classList.add("fade");
        document.getElementById(
          "overlay-bottom-right-text"
        ).innerText = `${video_width} x ${video_height}`;

        document.getElementById(
          "overlay-bottom-left-text"
        ).innerText = `${video_fps} FPS`;
      }

      //å¼€å§‹ä¸ºå½•åƒæ—¶é—´è®¡æ—¶
      function start_count() {
        document.getElementById("overlay-top-left-text").style.display = "";
        document.getElementById("overlay-top-right-text").style.display = "";
        document
          .querySelector(".overlay")
          .style.setProperty("--border-style", "2px solid red");

        //è®¡æ—¶å™¨å¹¶ä¸å‡†ç¡®ï¼Œæ‰€ä»¥ä½¿ç”¨å†…ç½®æ—¶é’Ÿçš„å½“å‰æ—¶é—´å‡å»ä¹‹å‰æ—¶é—´çš„å·®å€¼æ¥è¡¨ç¤ºå½•åƒæ—¶é—´
        let dt = new Date();
        start_time = dt.getTime();
        timer = setInterval(function () {
          let d = new Date();
          let now_time = d.getTime();
          let diff_time = now_time - start_time;
          let mini_sec = Math.floor((diff_time % 1000) / 10)
            .toString()
            .padStart(2, "0"); //ç§’æ•°åé¢ä¸¤ä½
          let sec = Math.floor((diff_time % 60000) / 1000)
            .toString()
            .padStart(2, "0"); //ç§’æ•°
          let minute = Math.floor((diff_time % 360000) / 60000)
            .toString()
            .padStart(2, "0"); //åˆ†é’Ÿæ•°
          document.getElementById(
            "overlay-top-right-text"
          ).innerText = `${minute}:${sec}:${mini_sec}`;
        }, 10);
      }

      //åœæ­¢è®¡æ—¶
      function stop_count() {
        document.getElementById("overlay-top-left-text").style.display = "none";
        document.getElementById("overlay-top-right-text").style.display =
          "none";
        document
          .querySelector(".overlay")
          .style.setProperty("--border-style", "2px solid white");
        clearInterval(timer);
      }

      async function open_camera() {
        //å½•åƒåŠŸèƒ½ä½¿ç”¨RecordRTC https://github.com/muaz-khan/RecordRTC
        //å®˜ç½‘    https://recordrtc.org/
        //RecordRTCæ˜¯WebRTC-Experimentçš„ä¸€éƒ¨åˆ†   https://github.com/muaz-khan/WebRTC-Experiment/tree/master

        //è·å–åˆ†è¾¨ç‡éƒ¨åˆ†ä»£ç å‚è€ƒ   https://usefulangle.com/post/355/javascript-get-camera-resolution
        //æ²¡æœ‰ç›´æ¥çš„æ–¹æ³•è·å–ç›¸æœºæ”¯æŒçš„æœ€å¤§åˆ†è¾¨ç‡ã€‚æ‰€ä»¥åªèƒ½æŒ‡å®šä¸€ä¸ªæœ€å¤§çš„ç†æƒ³å€¼ï¼Œå¦‚æœå¯ç”¨åˆ™è®¾ä¸ºç†æƒ³å€¼
        //å¦‚æœç†æƒ³å€¼ä¸å¯ç”¨ï¼Œåˆ™æµè§ˆå™¨å°†ä½¿ç”¨æœ€æ¥è¿‘ç†æƒ³å€¼çš„å€¼ã€‚

        //WebRTCè·å–ç›¸æœºåˆ†è¾¨ç‡çš„ä¸€ä¸ªå®ä¾‹ä»£ç    https://webrtc.github.io/samples/src/content/getusermedia/resolution/   *****å€¼å¾—å‚è€ƒ!!!****
        navigator.mediaDevices
          .getUserMedia({
            audio: true,
            video: {
              width: { ideal: 3840 },
              height: { ideal: 2160 },
              frameRate: { ideal: 60 },
            },
          })
          .then(async function (stream) {
            let settings = stream.getVideoTracks()[0].getSettings();

            video_width = settings.width;
            video_height = settings.height;
            video_fps = settings.frameRate;

            //console.log("è§†é¢‘å®é™…å®½åº¦: " + width + "px");
            //console.log("è§†é¢‘å®é™…é«˜åº¦: " + height + "px");
            //console.log("è§†é¢‘å®é™…FPS: " + video_fps);

            //è®¾ç½®video å®½åº¦ é«˜åº¦ å’Œ è§†é¢‘æµ
            video.width = video_width;
            video.height = video_height;
            video.srcObject = stream;
            recorder = RecordRTC(stream, {
              type: "video",
              mimeType: "video/mp4",
              recorderType: recorderType,
            });

            show_bottom();
            //ç¦ç”¨openæŒ‰é’®ï¼Œå¯ç”¨å½•åƒå’Œæˆªå›¾æŒ‰é’®
            document.getElementById("record").disabled = false;
            document.getElementById("photo").disabled = false;
            document.getElementById("open").disabled = true;
          })
          .catch(function (e) {
            console.log(e);
            alert("åˆ†è¾¨ç‡æ— æ•ˆï¼Œè¯·é‡æ–°é€‰æ‹©å¹¶å¼€å¯æ‘„åƒå¤´");
          });
      }

      function close_camera() {
        video.srcObject = null;
      }

      function record_act() {
        console.log(recorder.state);
        if (recorder.state == "inactive" || recorder.state == "stopped") {
          document.getElementById("record").innerHTML = "åœæ­¢å½•åƒ";
          record_start();
        } else if (recorder.state == "recording") {
          record_stop();
          document.getElementById("record").innerHTML = "å¼€å§‹å½•åƒ";
        }
      }

      function record_start() {
        recorder.startRecording();
        start_count();
      }

      //åœæ­¢å½•åƒæŒ‰é’®äº‹ä»¶
      function record_stop() {
        recorder.stopRecording(function () {
          let blob = recorder.getBlob();
          stop_count();
          //ä¿å­˜mp4ï¼Œæœ‰ä¸ªé—®é¢˜ï¼Œç°åœ¨ä¿å­˜çš„mp4åªèƒ½åœ¨æµè§ˆå™¨é‡Œæ‰“å¼€ï¼Œæœ‰ç©ºå†ç ”ç©¶
          invokeSaveAsDialog(blob, "video.mp4");
        });
      }

      function take_photo() {
        var canvas = document.createElement("canvas");
        canvas.width = video.videoWidth * scale;
        canvas.height = video.videoHeight * scale;
        canvas
          .getContext("2d")
          .drawImage(video, 0, 0, canvas.width, canvas.height);
        //å°†å›¾ç‰‡ä¿å­˜åˆ°æœ¬åœ°
        downloadBase64File(canvas.toDataURL("image/jpeg"), "img.jpg");
      }

      //ä¸‹è½½å›¾ç‰‡åˆ°æœ¬åœ°
      function downloadBase64File(contentBase64, fileName) {
        const linkSource = contentBase64;
        const downloadLink = document.createElement("a");
        document.body.appendChild(downloadLink);

        downloadLink.href = linkSource;
        downloadLink.target = "_self";
        downloadLink.download = fileName;
        downloadLink.click();
        downloadLink.remove();
      }
    </script>
  </body>
</html>
